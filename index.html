<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频转换工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"></script>
</head>
<body>
    <div class="container">
        <div class="video-converter">
            <h1 class="text-center mb-4">视频转换工具</h1>
            
            <div class="upload-section">
                <div class="upload-area" id="dropZone">
                    <i class="upload-icon">📁</i>
                    <p class="upload-text">拖拽文件到这里或点击选择文件</p>
                    <input type="file" id="fileInput" accept="video/*" class="file-input" multiple>
                </div>
            </div>

            <div class="selected-files mt-4" id="selectedFiles">
                <!-- 选中的文件将在这里显示 -->
            </div>

            <div class="conversion-options mt-4">
                <h4>转换选项</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="formatSelect" class="form-label">输出格式</label>
                            <select class="form-select" id="formatSelect">
                                <option value="mp4">MP4</option>
                                <option value="webm">WebM</option>
                                <option value="avi">AVI</option>
                                <option value="mov">MOV</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="qualitySelect" class="form-label">质量</label>
                            <select class="form-select" id="qualitySelect">
                                <option value="high">高质量</option>
                                <option value="medium">中等质量</option>
                                <option value="low">低质量</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="threadCount" class="form-label">线程数量</label>
                            <input type="number" class="form-control" id="threadCount" min="1" max="12" value="4">
                            <small class="form-text text-muted">推荐值: 1-12，具体取决于您的CPU核心数</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="progress mt-4 d-none" id="progressBar">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" id="convertBtn" disabled>开始转换</button>
            </div>

            <div class="result-section mt-4 d-none" id="resultSection">
                <h4>转换结果</h4>
                <div class="alert alert-success">
                    <p class="mb-2">转换完成！</p>
                    <a href="#" class="btn btn-success btn-sm" id="downloadBtn">下载文件</a>
                </div>
            </div>

            <div class="thread-info mt-3 alert alert-info">
                正在检测多线程支持...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const threadInfo = document.querySelector('.thread-info');
        const maxThreads = Math.min(navigator.hardwareConcurrency || 2, 12);
        document.getElementById('threadCount').max = maxThreads;
        
        // 使用配置创建 FFmpeg 实例
        const { createFFmpeg } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            threads: 4,
            progress: ({ ratio }) => {
                if (ratio && !isNaN(ratio)) {
                    updateCurrentFileProgress(ratio);
                }
            }
        });

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        let selectedFiles = new Map(); // 使用Map存储文件和其状态

        // 初始化 FFmpeg
        (async function() {
            try {
                await ffmpeg.load();
                console.log('FFmpeg 加载成功');
                threadInfo.textContent = `多线程已启用: 最大支持 ${maxThreads} 个线程`;
                threadInfo.className = 'mt-3 alert alert-success';
            } catch (err) {
                console.error('FFmpeg 加载失败:', err);
                alert('FFmpeg 加载失败，请刷新页面重试');
                threadInfo.textContent = '多线程初始化失败';
                threadInfo.className = 'mt-3 alert alert-danger';
            }
        })();

        // 更新当前文件的进度
        function updateCurrentFileProgress(ratio) {
            const currentFile = document.querySelector('.file-item.converting');
            if (currentFile) {
                const progress = currentFile.querySelector('.progress-bg');
                const percentage = Math.round(ratio * 100);
                progress.style.width = `${percentage}%`;
                currentFile.querySelector('.progress-text').textContent = `${percentage}%`;
            }
        }

        // 创建文件项
        function createFileItem(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.dataset.fileName = file.name;
            div.innerHTML = `
                <div class="progress-bg"></div>
                <span class="file-name">${file.name}</span>
                <span class="progress-text">等待转换</span>
                <button class="delete-btn" onclick="removeFile('${file.name}')">×</button>
            `;
            return div;
        }

        // 移除文件
        window.removeFile = function(fileName) {
            selectedFiles.delete(fileName);
            document.querySelector(`[data-file-name="${fileName}"]`).remove();
            updateConvertButton();
        }

        // 更新转换按钮状态
        function updateConvertButton() {
            convertBtn.disabled = selectedFiles.size === 0;
        }

        // 处理文件选择
        function handleFileSelect(files) {
            for (const file of files) {
                if (file.type.startsWith('video/')) {
                    selectedFiles.set(file.name, file);
                    selectedFilesDiv.appendChild(createFileItem(file));
                }
            }
            updateConvertButton();
        }

        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));

        // 处理拖拽
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#0d6efd';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
            handleFileSelect(e.dataTransfer.files);
        });

        // 转换单个文件
        async function convertFile(file, format, quality, threads) {
            const fileItem = document.querySelector(`[data-file-name="${file.name}"]`);
            fileItem.classList.add('converting');
            
            try {
                const data = await file.arrayBuffer();
                ffmpeg.FS('writeFile', 'input', new Uint8Array(data));

                let ffmpegArgs = ['-i', 'input'];
                
                // 设置编码器和线程
                ffmpegArgs.push(
                    '-c:v', 'libx264',        // 视频编码器
                    '-threads', String(threads), // 线程数
                    '-thread_type', 'frame',   // 线程类型：frame
                    '-x264-params', `threads=${threads}`, // x264编码器的线程数
                    '-row-mt', '1',           // 启用行级多线程
                    '-preset', 'veryfast'     // 使用更快的预设
                );

                // 根据质量设置参数
                switch(quality) {
                    case 'high':
                        ffmpegArgs.push('-crf', '18');
                        break;
                    case 'medium':
                        ffmpegArgs.push('-crf', '23');
                        break;
                    case 'low':
                        ffmpegArgs.push('-crf', '28');
                        break;
                }

                // 音频设置
                ffmpegArgs.push(
                    '-c:a', 'aac',
                    '-b:a', '128k',
                    '-movflags', '+faststart' // 优化视频加载速度
                );

                // 输出文件
                ffmpegArgs.push(`output.${format}`);

                console.log('FFmpeg 命令:', ffmpegArgs.join(' ')); // 输出完整命令以便调试

                await ffmpeg.run(...ffmpegArgs);

                const output = ffmpeg.FS('readFile', `output.${format}`);
                const outputBlob = new Blob([output.buffer], { type: `video/${format}` });
                
                // 创建下载链接
                const url = URL.createObjectURL(outputBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `converted_${file.name.split('.')[0]}.${format}`;
                a.click();
                URL.revokeObjectURL(url);

                // 清理
                ffmpeg.FS('unlink', 'input');
                ffmpeg.FS('unlink', `output.${format}`);

                fileItem.classList.remove('converting');
                fileItem.classList.add('converted');
                fileItem.querySelector('.progress-text').textContent = '转换完成';

            } catch (error) {
                console.error('转换错误:', error);
                fileItem.classList.remove('converting');
                fileItem.classList.add('error');
                fileItem.querySelector('.progress-text').textContent = '转换失败';
            }
        }

        // 转换按钮点击事件
        convertBtn.addEventListener('click', async () => {
            const format = document.getElementById('formatSelect').value;
            const quality = document.getElementById('qualitySelect').value;
            const threads = parseInt(document.getElementById('threadCount').value) || 4;

            convertBtn.disabled = true;

            // 依次转换每个文件
            for (const [_, file] of selectedFiles) {
                await convertFile(file, format, quality, threads);
            }

            convertBtn.disabled = false;
        });
    </script>
</body>
</html>
