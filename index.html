<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬æ¢å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"></script>
</head>
<body>
    <div class="container">
        <div class="video-converter">
            <h1 class="text-center mb-4">è§†é¢‘è½¬æ¢å·¥å…·</h1>
            
            <div class="upload-section">
                <div class="upload-area" id="dropZone">
                    <i class="upload-icon">ğŸ“</i>
                    <p class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept="video/*" class="file-input" multiple>
                </div>
            </div>

            <div class="selected-files mt-4" id="selectedFiles">
                <!-- é€‰ä¸­çš„æ–‡ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <div class="conversion-options mt-4">
                <h4>è½¬æ¢é€‰é¡¹</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="formatSelect" class="form-label">è¾“å‡ºæ ¼å¼</label>
                            <select class="form-select" id="formatSelect">
                                <option value="mp4">MP4</option>
                                <option value="webm">WebM</option>
                                <option value="avi">AVI</option>
                                <option value="mov">MOV</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="qualitySelect" class="form-label">è´¨é‡</label>
                            <select class="form-select" id="qualitySelect">
                                <option value="high">é«˜è´¨é‡</option>
                                <option value="medium">ä¸­ç­‰è´¨é‡</option>
                                <option value="low">ä½è´¨é‡</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="threadCount" class="form-label">çº¿ç¨‹æ•°é‡</label>
                            <input type="number" class="form-control" id="threadCount" min="1" max="12" value="4">
                            <small class="form-text text-muted">æ¨èå€¼: 1-12ï¼Œå…·ä½“å–å†³äºæ‚¨çš„CPUæ ¸å¿ƒæ•°</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="progress mt-4 d-none" id="progressBar">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" id="convertBtn" disabled>å¼€å§‹è½¬æ¢</button>
            </div>

            <div class="result-section mt-4 d-none" id="resultSection">
                <h4>è½¬æ¢ç»“æœ</h4>
                <div class="alert alert-success">
                    <p class="mb-2">è½¬æ¢å®Œæˆï¼</p>
                    <a href="#" class="btn btn-success btn-sm" id="downloadBtn">ä¸‹è½½æ–‡ä»¶</a>
                </div>
            </div>

            <div class="thread-info mt-3 alert alert-info">
                æ­£åœ¨æ£€æµ‹å¤šçº¿ç¨‹æ”¯æŒ...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const threadInfo = document.querySelector('.thread-info');
        const maxThreads = Math.min(navigator.hardwareConcurrency || 2, 12);
        document.getElementById('threadCount').max = maxThreads;
        
        // ä½¿ç”¨é…ç½®åˆ›å»º FFmpeg å®ä¾‹
        const { createFFmpeg } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            threads: 4,
            progress: ({ ratio }) => {
                if (ratio && !isNaN(ratio)) {
                    updateCurrentFileProgress(ratio);
                }
            }
        });

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        let selectedFiles = new Map(); // ä½¿ç”¨Mapå­˜å‚¨æ–‡ä»¶å’Œå…¶çŠ¶æ€

        // åˆå§‹åŒ– FFmpeg
        (async function() {
            try {
                await ffmpeg.load();
                console.log('FFmpeg åŠ è½½æˆåŠŸ');
                threadInfo.textContent = `å¤šçº¿ç¨‹å·²å¯ç”¨: æœ€å¤§æ”¯æŒ ${maxThreads} ä¸ªçº¿ç¨‹`;
                threadInfo.className = 'mt-3 alert alert-success';
            } catch (err) {
                console.error('FFmpeg åŠ è½½å¤±è´¥:', err);
                alert('FFmpeg åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                threadInfo.textContent = 'å¤šçº¿ç¨‹åˆå§‹åŒ–å¤±è´¥';
                threadInfo.className = 'mt-3 alert alert-danger';
            }
        })();

        // æ›´æ–°å½“å‰æ–‡ä»¶çš„è¿›åº¦
        function updateCurrentFileProgress(ratio) {
            const currentFile = document.querySelector('.file-item.converting');
            if (currentFile) {
                const progress = currentFile.querySelector('.progress-bg');
                const percentage = Math.round(ratio * 100);
                progress.style.width = `${percentage}%`;
                currentFile.querySelector('.progress-text').textContent = `${percentage}%`;
            }
        }

        // åˆ›å»ºæ–‡ä»¶é¡¹
        function createFileItem(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.dataset.fileName = file.name;
            div.innerHTML = `
                <div class="progress-bg"></div>
                <span class="file-name">${file.name}</span>
                <span class="progress-text">ç­‰å¾…è½¬æ¢</span>
                <button class="delete-btn" onclick="removeFile('${file.name}')">Ã—</button>
            `;
            return div;
        }

        // ç§»é™¤æ–‡ä»¶
        window.removeFile = function(fileName) {
            selectedFiles.delete(fileName);
            document.querySelector(`[data-file-name="${fileName}"]`).remove();
            updateConvertButton();
        }

        // æ›´æ–°è½¬æ¢æŒ‰é’®çŠ¶æ€
        function updateConvertButton() {
            convertBtn.disabled = selectedFiles.size === 0;
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(files) {
            for (const file of files) {
                if (file.type.startsWith('video/')) {
                    selectedFiles.set(file.name, file);
                    selectedFilesDiv.appendChild(createFileItem(file));
                }
            }
            updateConvertButton();
        }

        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));

        // å¤„ç†æ‹–æ‹½
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#0d6efd';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
            handleFileSelect(e.dataTransfer.files);
        });

        // è½¬æ¢å•ä¸ªæ–‡ä»¶
        async function convertFile(file, format, quality, threads) {
            const fileItem = document.querySelector(`[data-file-name="${file.name}"]`);
            fileItem.classList.add('converting');
            
            try {
                const data = await file.arrayBuffer();
                ffmpeg.FS('writeFile', 'input', new Uint8Array(data));

                let ffmpegArgs = ['-i', 'input'];
                
                // è®¾ç½®ç¼–ç å™¨å’Œçº¿ç¨‹
                ffmpegArgs.push(
                    '-c:v', 'libx264',        // è§†é¢‘ç¼–ç å™¨
                    '-threads', String(threads), // çº¿ç¨‹æ•°
                    '-thread_type', 'frame',   // çº¿ç¨‹ç±»å‹ï¼šframe
                    '-x264-params', `threads=${threads}`, // x264ç¼–ç å™¨çš„çº¿ç¨‹æ•°
                    '-row-mt', '1',           // å¯ç”¨è¡Œçº§å¤šçº¿ç¨‹
                    '-preset', 'veryfast'     // ä½¿ç”¨æ›´å¿«çš„é¢„è®¾
                );

                // æ ¹æ®è´¨é‡è®¾ç½®å‚æ•°
                switch(quality) {
                    case 'high':
                        ffmpegArgs.push('-crf', '18');
                        break;
                    case 'medium':
                        ffmpegArgs.push('-crf', '23');
                        break;
                    case 'low':
                        ffmpegArgs.push('-crf', '28');
                        break;
                }

                // éŸ³é¢‘è®¾ç½®
                ffmpegArgs.push(
                    '-c:a', 'aac',
                    '-b:a', '128k',
                    '-movflags', '+faststart' // ä¼˜åŒ–è§†é¢‘åŠ è½½é€Ÿåº¦
                );

                // è¾“å‡ºæ–‡ä»¶
                ffmpegArgs.push(`output.${format}`);

                console.log('FFmpeg å‘½ä»¤:', ffmpegArgs.join(' ')); // è¾“å‡ºå®Œæ•´å‘½ä»¤ä»¥ä¾¿è°ƒè¯•

                await ffmpeg.run(...ffmpegArgs);

                const output = ffmpeg.FS('readFile', `output.${format}`);
                const outputBlob = new Blob([output.buffer], { type: `video/${format}` });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(outputBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `converted_${file.name.split('.')[0]}.${format}`;
                a.click();
                URL.revokeObjectURL(url);

                // æ¸…ç†
                ffmpeg.FS('unlink', 'input');
                ffmpeg.FS('unlink', `output.${format}`);

                fileItem.classList.remove('converting');
                fileItem.classList.add('converted');
                fileItem.querySelector('.progress-text').textContent = 'è½¬æ¢å®Œæˆ';

            } catch (error) {
                console.error('è½¬æ¢é”™è¯¯:', error);
                fileItem.classList.remove('converting');
                fileItem.classList.add('error');
                fileItem.querySelector('.progress-text').textContent = 'è½¬æ¢å¤±è´¥';
            }
        }

        // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        convertBtn.addEventListener('click', async () => {
            const format = document.getElementById('formatSelect').value;
            const quality = document.getElementById('qualitySelect').value;
            const threads = parseInt(document.getElementById('threadCount').value) || 4;

            convertBtn.disabled = true;

            // ä¾æ¬¡è½¬æ¢æ¯ä¸ªæ–‡ä»¶
            for (const [_, file] of selectedFiles) {
                await convertFile(file, format, quality, threads);
            }

            convertBtn.disabled = false;
        });
    </script>
</body>
</html>
