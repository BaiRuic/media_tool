<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬æ¢å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"></script>
</head>
<body>
    <div class="container">
        <div class="video-converter">
            <h1 class="text-center mb-4">è§†é¢‘è½¬æ¢å·¥å…·</h1>
            
            <div class="upload-section">
                <div class="upload-area" id="dropZone">
                    <i class="upload-icon">ğŸ“</i>
                    <p class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept="video/*" class="file-input">
                </div>
            </div>

            <div class="conversion-options mt-4">
                <h4>è½¬æ¢é€‰é¡¹</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="formatSelect" class="form-label">è¾“å‡ºæ ¼å¼</label>
                            <select class="form-select" id="formatSelect">
                                <option value="mp4">MP4</option>
                                <option value="webm">WebM</option>
                                <option value="avi">AVI</option>
                                <option value="mov">MOV</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="qualitySelect" class="form-label">è´¨é‡</label>
                            <select class="form-select" id="qualitySelect">
                                <option value="high">é«˜è´¨é‡</option>
                                <option value="medium">ä¸­ç­‰è´¨é‡</option>
                                <option value="low">ä½è´¨é‡</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="progress mt-4 d-none" id="progressBar">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" id="convertBtn" disabled>å¼€å§‹è½¬æ¢</button>
            </div>

            <div class="result-section mt-4 d-none" id="resultSection">
                <h4>è½¬æ¢ç»“æœ</h4>
                <div class="alert alert-success">
                    <p class="mb-2">è½¬æ¢å®Œæˆï¼</p>
                    <a href="#" class="btn btn-success btn-sm" id="downloadBtn">ä¸‹è½½æ–‡ä»¶</a>
                </div>
            </div>

            <div class="thread-info mt-3 alert alert-info">
                æ­£åœ¨æ£€æµ‹å¤šçº¿ç¨‹æ”¯æŒ...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const threadInfo = document.querySelector('.thread-info');
        // é™åˆ¶æœ€å¤§çº¿ç¨‹æ•°ä¸º4
        const numThreads = Math.min(navigator.hardwareConcurrency || 2, 4);
        
        // ä½¿ç”¨é…ç½®åˆ›å»º FFmpeg å®ä¾‹
        const { createFFmpeg } = FFmpeg;
        const ffmpeg = createFFmpeg({
            log: true,
            threads: numThreads,
            progress: ({ ratio }) => {
                if (ratio && !isNaN(ratio)) {
                    const progressElement = progressBar.querySelector('.progress-bar');
                    progressElement.style.width = `${ratio * 100}%`;
                    progressElement.setAttribute('aria-valuenow', ratio * 100);
                }
            }
        });

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const progressBar = document.getElementById('progressBar');
        const resultSection = document.getElementById('resultSection');
        const downloadBtn = document.getElementById('downloadBtn');
        let selectedFile = null;

        // åˆå§‹åŒ– FFmpeg
        (async function() {
            try {
                await ffmpeg.load();
                console.log('FFmpeg åŠ è½½æˆåŠŸ');
                threadInfo.textContent = `å¤šçº¿ç¨‹å·²å¯ç”¨: ä½¿ç”¨ ${numThreads} ä¸ªçº¿ç¨‹è¿›è¡Œè½¬æ¢`;
                threadInfo.className = 'mt-3 alert alert-success';
            } catch (err) {
                console.error('FFmpeg åŠ è½½å¤±è´¥:', err);
                alert('FFmpeg åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                threadInfo.textContent = 'å¤šçº¿ç¨‹åˆå§‹åŒ–å¤±è´¥';
                threadInfo.className = 'mt-3 alert alert-danger';
            }
        })();

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', handleFileSelect);

        // å¤„ç†æ‹–æ‹½
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#0d6efd';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#6c757d';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                if (file.type.startsWith('video/')) {
                    selectedFile = file;
                    convertBtn.disabled = false;
                    document.querySelector('.upload-text').textContent = `å·²é€‰æ‹©: ${file.name}`;
                } else {
                    alert('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼');
                    fileInput.value = '';
                    convertBtn.disabled = true;
                    selectedFile = null;
                }
            }
        }

        // è½¬æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const formatSelect = document.getElementById('formatSelect');
            const qualitySelect = document.getElementById('qualitySelect');
            const outputFormat = formatSelect.value;
            const quality = qualitySelect.value;

            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBar.classList.remove('d-none');
            const progressElement = progressBar.querySelector('.progress-bar');
            progressElement.style.width = '0%';
            convertBtn.disabled = true;

            try {
                // è¯»å–æ–‡ä»¶
                const data = await selectedFile.arrayBuffer();
                ffmpeg.FS('writeFile', 'input', new Uint8Array(data));

                // è®¾ç½®è½¬æ¢å‚æ•°
                let ffmpegArgs = [];
                switch(quality) {
                    case 'high':
                        ffmpegArgs = ['-i', 'input', '-c:v', 'libx264', '-preset', 'medium', '-crf', '18', '-threads', String(numThreads), '-thread_type', 'frame'];
                        break;
                    case 'medium':
                        ffmpegArgs = ['-i', 'input', '-c:v', 'libx264', '-preset', 'medium', '-crf', '23', '-threads', String(numThreads), '-thread_type', 'frame'];
                        break;
                    case 'low':
                        ffmpegArgs = ['-i', 'input', '-c:v', 'libx264', '-preset', 'medium', '-crf', '28', '-threads', String(numThreads), '-thread_type', 'frame'];
                        break;
                }

                // æ·»åŠ éŸ³é¢‘ç›¸å…³å‚æ•°
                ffmpegArgs.push('-c:a', 'aac', '-b:a', '128k');
                ffmpegArgs.push(`output.${outputFormat}`);

                // æ‰§è¡Œè½¬æ¢
                await ffmpeg.run(...ffmpegArgs);

                // è·å–è¾“å‡ºæ–‡ä»¶
                const output = ffmpeg.FS('readFile', `output.${outputFormat}`);
                const outputBlob = new Blob([output.buffer], { type: `video/${outputFormat}` });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(outputBlob);
                downloadBtn.href = url;
                downloadBtn.download = `converted_video.${outputFormat}`;

                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                resultSection.classList.remove('d-none');

                // æ¸…ç†
                ffmpeg.FS('unlink', 'input');
                ffmpeg.FS('unlink', `output.${outputFormat}`);

            } catch (error) {
                console.error('è½¬æ¢é”™è¯¯:', error);
                alert('è§†é¢‘è½¬æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
            } finally {
                convertBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
